<video id="video" width="520"></video><br>
<button id="play">play</button><br>
<input id="comment" type="text"><button id="send">コメント</button>
<div id="local-comments"></div>
<!-- <div id="comments"></div> -->
<script>
  // video
  const video = document.getElementById("video");
  const queryStr = location.href.split("?")[1];
  const query = {};
  queryStr.split("&").map(q => q.split("=")).forEach(q => query[q[0]] = q[1]);
  video.setAttribute("src", `/video/${query.id}`);

  let playing = false;
  video.addEventListener("playing", () => {
    playing = true;
    play.innerHTML = "pause";
    console.log("play");
    showComment();
  });
  video.addEventListener("pause", () => {
    playing = false;
    play.innerHTML = "play";
    console.log("pause");
  });

  const play = document.getElementById("play");
  play.addEventListener("click", () => {
    if (playing) {
      video.pause();
    } else {
      video.play();
    }
    playing = !playing;
  });

  // send comment
  const comment = document.getElementById("comment");
  const send = document.getElementById("send");
  send.addEventListener("click", async () => {
    const com = comment.value;
    comment.value = "";
    comment.focus();
    const time = video.currentTime;
    await fetch(`/comment/${query.id}`, {
      method: "POST",
      headers: {
        "content-type": "application/json"
      },
      body: JSON.stringify({
        comment: com,
        time: time,
      }),
    });
    addComment(com);
    // await list();
  });

  async function list() {
    const comments = document.getElementById("comments");
    comments.innerHTML = "";
    const c = await fetch(`/comment/${query.id}`);
    const arrC = await c.json();
    arrC.forEach((a) => {
      const el = document.createElement("div");
      el.innerHTML = a.comment + "/" + a.time;
      comments.appendChild(el);
    });
  }

  async function showComment() {
    if (!playing) {
      return;
    }
    // comments.innerHTML = "";
    const c = await fetch(`/comment/${query.id}`);
    const arrC = await c.json();
    const now = video.currentTime;

    arrC.filter(e => (e.time > now && e.time < now + 0.5)).forEach((a) => {
      addComment(a.comment);
    });
    setTimeout(showComment, 500);
  }

  function addComment(comment) {
    const comments = document.getElementById("local-comments");
    const el = document.createElement("div");
    el.innerHTML = comment;
    comments.appendChild(el);
    setTimeout(() => {
      comments.removeChild(el);
    }, 2000);
  }

  // list();
</script>